Виртуализация

1. Что такое виртуализация? Для чего она нужна? Примеры использования.
2. Что такое гипервизор? Гипервизоры 1 и 2 типа, их преимущества и недостатки.
3. Виртуализация до VT и SVM и после.
4. Перерасход, дедупликация и баллунинг


1: Виртуализация - технология которая позволяет создавать несколько независимых машин на одном устройстве. Такие машины называются виртуальными. Пример: веб хостинг.


2: Виртуализация происходит с помощью специального ПО - гипервизора. Т.е. гипервизор - это программа, которая предоставляет возможность запуска виртуальных машин. Они бывают двух типов. Гипервизор 1 типа характеризуется тем, что он ставится на "голое" железо. Это обеспечивает хорошую производительность, но накладывает ограничения на поддерживаемые устройства. Гипервизор 2 типа работает поверх основой ОС. Это позволяет не беспокоиться за поддержку устройств, потому что за драйверами гипервизор может обратиться к основой системе. Но такой подход менее эффективен из-за наличия дополнительного уровня в виде основной ОС.



3: Процессоры архитектуры x86 до 2005 года не поддерживали виртуализацию на аппаратном уровне. Гипервизоры использовали технологию двоичной трансляции или паравиртуализации. При первом способе, гипервизор анализировал инструкции, выполняемые гостевой ОС и заменял привилегированные вызовы, на безопасные аналоги. То есть если нужно было выполнить команду, например, перемещения регистра заменялась на гипервызов, и гипервизор самостоятельно выполнял опасную команду. Паравиртуализация имеет похожий принцип, только здесь модифицируется ядро гостевой ОС. Служебные команды заменяются на гипервызовы. Двоичная трансляция работает медленнее, ведь гипервизору нужно постоянно следить и заменять привилегированные инструкции.

Служебная (привилегированная) инструкция - инструкции, которые требуют взаимодействия с аппаратной частью. При виртуализации их нельзя допускать т.к. гостевая ОС не должна взаимодействовать с реальным оборудованием напрямую.

В 2005 году появились технологии Virtualization Technology (VT)(Intel) и Secure Virtual Machine (SVM)(AMD). Это добавило процессорам поддержку виртуализации на аппаратном уровне. Теперь, когда гостевая ОС выполняет привилегированную инструкцию, процессор автоматически передаёт управление гипервизору, без необходимости переписывать команду или ядро системы. Также были добавлены Extended Page Tables (EPT)(Intel) или Nested Page Tables (NPT)(AMD). Это изменило подход к виртуальной памяти в гостевых ОС. До этого гипервизор дублировал таблицы страниц гостевой ОС, такая таблица называлась теневой. При обращении гостевой ОС по виртуальному адресу, управление перехватывал гипервизор и обращался по адресу из теневой таблицы. Можно сказать что гипервизор выступал в роли MMU. Однако такой подход неэффективен, ведь при каждом обращении к памяти, нужно участие гипервизора. Более того, при каждом изменении таблицы гостевой ОС, нужно было менять и теневую таблицу и сбрасывать TLB (из-за неактуальности). С появлением аппаратной виртуализации, гостевая ОС стала работать со своими таблицами в обычном режиме, а на выходе процессор преобразовывал гостевой физический адрес в реальный физический, без необходимости вызова гипервизора. Он будет вызываться только в случае ошибки (EPT violation (аналог page fault)).


4: Для эффективности гипервизор может выделять виртуальным машинам больше ресурсов, чем доступно у хоста. Расчёт идёт на то, что всем системам вряд ли понадобятся все их ресурсы одновременно. При таком подходе, с целью оптимизации, используется дедупликация. Дедупликация - процесс устранения дублирующихся данных для сохранения занимаемого пространства. Например, виртуальные машины могут использовать один и тот же образ ОС, или гостевые ОС могут пользоваться одинаковыми данными из RAM. Кроме этого используется ballooning. В каждую виртуальную машину, в качестве псевдодрайвера устройства, общающегося с гипервизором, загружается модуль. При нехватке памяти, гипервизор будет "раздувать" этот модуль, заставляя систему выгружать наименее нужные страницы памяти, тем самым освобождая ресурсы для других систем.